---
title: "LD"
author: "Xiaodong"
date: "2025-02-12"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Solution to exercise on LD

## LD decay

```{bash}
startMarker="HiC_scaffold_1:18740115:G:A"
endMarker="HiC_scaffold_1:51825208:C:."

for f in Black   W-Serengeti
do 
    cat   /home/pls394/popgen_2025/extra_exercise/data/wildebeest.fam | grep $f | cut -f1,2 | head -n5 > ${f}.txt
    plink --bfile  /home/pls394/popgen_2025/extra_exercise/data/wildebeest --keep ${f}.txt --chr HiC_scaffold_1  --allow-extra-chr  --make-bed --out ${f}.chr1
    plink --bfile ${f}.chr1 --allow-extra-chr --from $startMarker --to $endMarker --make-bed --out ${f}.chr1.maf01.geno0.region --geno 0 --maf 0.1
done

for f in  Black W-Serengeti
do 
    cat   /home/pls394/popgen_2025/extra_exercise/data/wildebeest.fam | grep $f | cut -f1,2 | head -n3 > ${f}.txt
    plink --bfile  /home/pls394/popgen_2025/extra_exercise/data/wildebeest --keep ${f}.txt --chr HiC_scaffold_1  --allow-extra-chr  --make-bed --out ${f}.chr1.3ind
    plink --bfile ${f}.chr1.3ind --allow-extra-chr --from $startMarker --to $endMarker --make-bed --out ${f}.chr1.maf01.geno0.region.3ind --geno 0 --maf 0.1
done
```

Work on LD decay of Black (n=5)

```{r}
library("snpMatrix")
data<- read.plink("Black.chr1.maf01.geno0.region")
ld<- ld.snp(data, dep=500)
do.rsq2 <- ("rsq2" %in% names(ld))
snp.names <- attr(ld, "snp.names")
name<- c("#M1", "#M2", "rsq2", "Dprime", "lod")
r.maybe <- ld$rsq2
max.depth <- dim(ld$dprime)[2]
res<-matrix(NA,ncol=3,nrow=length(snp.names)*max.depth)
count<-1
for (i.snp in c(1:(length(snp.names) - 1))) {
  for (j.snp in c((i.snp + 1):length(snp.names))) {
    step <- j.snp - i.snp
    if (step > max.depth) {
      break
    }
    res[count,]<-c(snp.names[i.snp], snp.names[j.snp],r.maybe[i.snp, step])
    count<-count+1;
  }
}

res[,1] <- gsub(":.*","",gsub(".*_1:", "", res[,1]))
res[,2] <- gsub(":.*","",gsub(".*_1:", "", res[,2]))
resNum<-as.numeric(res)#converts to numeric values
dim(resNum)<-dim(res)
dis<- resNum[,2]-resNum[,1] #calculates distances between sites
disbin<- cut(dis, br=seq(0,1000000,by=5000))
#cuts distances into bins of size 1K from distance "0" to "2000000"
res<- tapply(resNum[,3], disbin, mean, na.rm=T)
#takes the mean of r2 (3rd column in resNum) in each bin, removes "NA", and distances >2K
pdf("Wildebeest.1Mb.pdf") #saves output as a .pdf
plot(res, type="l", ylim=c(0.15, 0.6),col='black')
#plot(res, type="l", ylim=c(0.15, 0.6),col='black'     ,xlim=c(0,4000))
```

Work on LD decay of W-Serengeti (n=5)

```{R}
data<- read.plink("W-Serengeti.chr1.maf01.geno0.region")
ld<- ld.snp(data, dep=500)
do.rsq2 <- ("rsq2" %in% names(ld))
snp.names <- attr(ld, "snp.names")
name<- c("#M1", "#M2", "rsq2", "Dprime", "lod")
r.maybe <- ld$rsq2
max.depth <- dim(ld$dprime)[2]
res<-matrix(NA,ncol=3,nrow=length(snp.names)*max.depth)
count<-1
for (i.snp in c(1:(length(snp.names) - 1))) {
  for (j.snp in c((i.snp + 1):length(snp.names))) {
    step <- j.snp - i.snp
    if (step > max.depth) {
      break
    }
    res[count,]<-c(snp.names[i.snp], snp.names[j.snp],r.maybe[i.snp, step])
    count<-count+1;
  }
}

res[,1] <- gsub(":.*","",gsub(".*_1:", "", res[,1]))
res[,2] <- gsub(":.*","",gsub(".*_1:", "", res[,2]))
resNum<-as.numeric(res)#converts to numeric values
dim(resNum)<-dim(res)
dis<- resNum[,2]-resNum[,1] #calculates distances between sites
disbin<- cut(dis, br=seq(0,1000000,by=5000))
#cuts distances into bins of size 1K from distance "0" to "2000000"
res<- tapply(resNum[,3], disbin, mean, na.rm=T)
lines(res,type="l",col='blue')
```

Work on LD decay of W-Serengeti (n=3)

```{R}
data<- read.plink("W-Serengeti.chr1.maf01.geno0.region.3ind")
ld<- ld.snp(data, dep=500)
do.rsq2 <- ("rsq2" %in% names(ld))
snp.names <- attr(ld, "snp.names")
name<- c("#M1", "#M2", "rsq2", "Dprime", "lod")
r.maybe <- ld$rsq2
max.depth <- dim(ld$dprime)[2]
res<-matrix(NA,ncol=3,nrow=length(snp.names)*max.depth)
count<-1
for (i.snp in c(1:(length(snp.names) - 1))) {
  for (j.snp in c((i.snp + 1):length(snp.names))) {
    step <- j.snp - i.snp
    if (step > max.depth) {
      break
    }
    res[count,]<-c(snp.names[i.snp], snp.names[j.snp],r.maybe[i.snp, step])
    count<-count+1;
  }
}

res[,1] <- gsub(":.*","",gsub(".*_1:", "", res[,1]))
res[,2] <- gsub(":.*","",gsub(".*_1:", "", res[,2]))
resNum<-as.numeric(res)#converts to numeric values
dim(resNum)<-dim(res)
dis<- resNum[,2]-resNum[,1] #calculates distances between sites
disbin<- cut(dis, br=seq(0,1000000,by=5000))
#cuts distances into bins of size 1K from distance "0" to "2000000"
res<- tapply(resNum[,3], disbin, mean, na.rm=T)
lines(res,type="l",col='light blue')

legend('topright',legend=c("Black:5ind","W-Serengeti:5ind","W-Serengeti:3ind"),col=c('black','blue','lightblue'),pch=16)
dev.off()
```

![](Wildebeest.1Mb.png)

# LD block

```{bash}
startMarker="HiC_scaffold_1:18740115:G:A"
endMarker="HiC_scaffold_1:23756744:G:."

for f in Black   W-Serengeti
do 

    plink --bfile ${f}.chr1 --allow-extra-chr --from $startMarker --to $endMarker --make-bed --out ${f}.chr1.block --geno 0 --maf 0.1
done
```

```{R}
data <- read.plink("Black.chr1.block")
ld <- ld.snp(data, dep=300)
plot.snp.dprime(ld, filename="Black.block.eps", res=100)
```

![](Black.block.png)

```{R}
data <- read.plink("W-Serengeti.chr1.block")
ld <- ld.snp(data, dep=300)
plot.snp.dprime(ld, filename="W-Serengeti.block.eps", res=100)
```

![](W-Serengeti.block.png)
